<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Clinical Copilot — App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { hcblue: '#0D6EFD' } /* healthcare blue */
        }
      }
    }
  </script>

  <style>
    /* subtle enter animation */
    .reveal { opacity:0; transform: translateY(10px); transition: opacity .4s ease, transform .4s ease; }
    .reveal.show { opacity:1; transform:none; }
  </style>
</head>
<body class="bg-slate-50">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <!-- Top bar -->
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="inline-block w-8 h-8 rounded-xl bg-hcblue/90 shadow-md"></span>
        <div class="font-semibold">Clinical Copilot</div>
      </div>
      <div class="text-sm text-slate-600 flex items-center gap-2">
        <span id="dot" class="w-2.5 h-2.5 rounded-full bg-slate-300"></span>
        <span id="statText">Checking…</span>
      </div>
    </div>

    <!-- Main two-column layout -->
    <section class="grid lg:grid-cols-2 gap-6">
      <!-- Left: Ask panel -->
      <div class="bg-white rounded-2xl shadow p-5 reveal">
        <h2 class="font-semibold mb-2">Ask</h2>

        <label class="block text-sm font-medium mb-1">Question</label>
        <input id="q" class="w-full border rounded px-3 py-2 mb-3"
               placeholder="fever + productive cough + pleuritic chest pain — next steps?" />

        <div class="flex items-center justify-between mb-1">
          <label class="text-sm font-medium">Enter the patient details:</label>
        </div>
        <textarea id="facts" class="w-full h-40 border rounded p-2 text-sm"
          placeholder='[{"text":"O2 sat 92% RA"}]'></textarea>

        <div class="mt-3 flex gap-3 items-center">
          <button id="askBtn"
                  class="px-4 py-2 bg-hcblue text-white rounded-lg hover:bg-blue-700">
            Ask
          </button>
          <span id="status" class="text-sm text-slate-500"></span>
        </div>

        <p class="text-xs text-slate-500 mt-2">
          Endpoint: <code>POST http://127.0.0.1:9000/reason</code>  
          (visit <code>GET /reason</code> in browser for info)
        </p>

      </div>

      <!-- Right: Dashboard + Recent Cases (replaces Notes & Tips) -->
      <div class="space-y-6">
        <!-- Live Dashboard -->
        <div class="bg-white rounded-2xl shadow p-5 reveal">
          <h2 class="font-semibold mb-4 text-slate-800">Live Dashboard</h2>
          <div class="grid grid-cols-3 gap-4 text-center">
            <div class="rounded-lg border p-4">
              <div id="countCases" class="text-2xl font-bold text-hcblue">0</div>
              <div class="text-xs text-slate-500">Cases processed</div>
            </div>
            <div class="rounded-lg border p-4">
              <div id="countLatency" class="text-2xl font-bold text-hcblue">—</div>
              <div class="text-xs text-slate-500">Avg latency</div>
            </div>
            <div class="rounded-lg border p-4">
              <div id="countFlags" class="text-2xl font-bold text-hcblue">0</div>
              <div class="text-xs text-slate-500">Red-flag triggers</div>
            </div>
          </div>
        </div>

        <!-- Recent Cases -->
        <div class="bg-white rounded-2xl shadow p-5 reveal">
          <h2 class="font-semibold mb-3 text-slate-800">Recent Cases</h2>
          <ul id="recentCases" class="text-sm space-y-2 text-slate-700">
            <!-- new items are prepended here -->
          </ul>
          <p class="mt-3 text-xs text-slate-400">
            Tip: this list auto-updates every time you run a case.
          </p>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section id="results" class="hidden"></section>
  </div>

  <script>
    // Config
    const API = "http://127.0.0.1:9000";
    const CITATION_LINKS = {
      "cap_idsa_2019.txt": "https://www.idsociety.org/practice-guideline/community-acquired-pneumonia-cap-in-adults/",
      "kdigo_ckd_2022.txt": "https://kdigo.org/guidelines/ckd-evaluation-and-management/",
      "ada_diabetes_2024.txt": "https://diabetesjournals.org/care/issue"
    };
    const $ = (id) => document.getElementById(id);
    const esc = s => String(s ?? "").replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));

    // Simple reveal on view
    const io = new IntersectionObserver(es => es.forEach(e => {
      if (e.isIntersecting) { e.target.classList.add('show'); io.unobserve(e.target); }
    }), {threshold:.2});
    document.querySelectorAll('.reveal').forEach(el => io.observe(el));

    // Backend status dot
    (async () => {
      try {
        const r = await fetch(`${API}/status`);
        $("dot").className = "w-2.5 h-2.5 rounded-full " + (r.ok ? "bg-emerald-500" : "bg-rose-500");
        $("statText").textContent = r.ok ? "Backend up" : "Backend down";
      } catch {
        $("dot").className = "w-2.5 h-2.5 rounded-full bg-rose-500";
        $("statText").textContent = "Backend down";
      }
    })();

    // Dashboard state
    let caseCount = 0;
    let totalLatency = 0;
    let redFlags = 0;

    function updateDashboard(latencyMs, summary) {
      caseCount++;
      totalLatency += latencyMs;
      const avg = totalLatency / caseCount;
      $("countCases").textContent = caseCount;
      $("countLatency").textContent = isFinite(avg) ? `${avg.toFixed(0)} ms` : "—";

      const flags = Array.isArray(summary?.red_flags) ? summary.red_flags.length : 0;
      if (flags > 0) redFlags += flags;
      $("countFlags").textContent = redFlags;
    }

    function logCase(question, summary) {
      const ul = $("recentCases");
      const li = document.createElement("li");
      li.className = "border-l-2 border-blue-400 pl-2";
      const prob = summary?.problem ? ` — ${summary.problem}` : "";
      li.textContent = `${question}${prob}`;
      ul.prepend(li);
      // keep last 6
      while (ul.children.length > 6) ul.removeChild(ul.lastChild);
    }

    // Ask handler
    $("askBtn").onclick = async () => {
      const question = $("q").value;
      let facts = [];
      try {
        facts = $("facts").value.trim() ? JSON.parse($("facts").value) : [];
        if (!Array.isArray(facts)) throw new Error();
      } catch {
        alert('Patient facts must be valid JSON array.\nExample:\n[\n  {"text":"O2 sat 92% RA"}\n]');
        return;
      }

      $("status").textContent = "Processing…";
      const t0 = performance.now();
      try {
        const r = await fetch(`${API}/reason`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ question, patient_facts: facts })
        });
        const t1 = performance.now();
        if (!r.ok) {
          $("status").textContent = "Request failed.";
          return alert(`Request failed: ${r.status} ${r.statusText}`);
        }
        const j = await r.json();
        $("status").textContent = "";
        renderResults(j);
        updateDashboard(t1 - t0, j.summary);
        logCase(question, j.summary);
      } catch (e) {
        $("status").textContent = "Network error.";
        alert(e?.message || e);
      }
    };

    // Render results (summary-centric)
    function renderResults(resp) {
      const sum = resp?.summary;
      const el = $("results");
      el.classList.remove("hidden");

      const section = (title, items) => {
        if (!items || !items.length) return "";
        return `
          <h3 class="text-lg font-semibold mt-6">${esc(title)}</h3>
          <ul class="list-disc pl-5 mt-2 text-sm">
            ${items.map(s => `<li>${esc(s)}</li>`).join("")}
          </ul>`;
      };

      const cites = (sum?.citations || []).map(c => {
        const url = CITATION_LINKS[c];
        return url
          ? `<a class="underline" href="${url}" target="_blank" rel="noreferrer">${esc(c)}</a>`
          : `<span class="font-mono">${esc(c)}</span>`;
      }).join(", ") || "—";

      el.innerHTML = `
        <div class="bg-white rounded-2xl shadow p-6 reveal show">
          <h2 class="text-2xl font-semibold mb-2">Clinical Summary</h2>
          <p class="text-sm text-slate-700 mb-4">
            <span class="font-medium">Problem:</span> ${esc(sum?.problem || "")}
          </p>

          ${sum?.factors?.relevant?.length ? `
            <h3 class="text-lg font-semibold">Key Relevant Factors</h3>
            <ul class="list-disc pl-5 mt-2 text-sm">
              ${sum.factors.relevant.map(s => `<li>${esc(s)}</li>`).join("")}
            </ul>` : ""}

          ${section("Differential (prioritized)", sum?.differential)}
          ${section("Diagnostics", sum?.diagnostics)}
          ${section("Treatment", sum?.treatment)}
          ${section("Disposition", sum?.disposition)}
          ${section("Patient Counseling", sum?.counseling)}
          ${section("Red Flags:", sum?.red_flags)}

          <div class="mt-6 text-xs text-slate-500">
            <span class="font-medium">Citations:</span> ${cites}
            ${resp?.engine ? ` &nbsp;·&nbsp; engine: ${esc(resp.engine)}` : ""}
          </div>
        </div>
      `;
    }
  </script>
</body>
</html>